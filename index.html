<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Students • Symmetric Tree (Math → Grade)</title>
<style>
  :root{
    --bg:#ffffff; --text:#111827;
    --edge:#333333;
    --root:#f472b6;       /* pink root */
    --internal:#fbbf24;   /* orange internal nodes */
    /* four leaves (left-left, left-right, right-left, right-right) */
    --leaf-ll:#f59e0b;    /* A range */
    --leaf-lr:#ec4899;    /* B range */
    --leaf-rl:#22c55e;    /* C range */
    --leaf-rr:#0ea5e9;    /* D/F range */
    --ball-neutral:#64748b;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;}
  .wrap{max-width:1020px;margin:22px auto;padding:14px;}
  h1{margin:0 0 10px;text-align:center;font-size:22px;}
  .panel{position:relative;border-radius:14px;box-shadow:0 10px 25px rgba(2,6,23,.06);padding:10px;}
  .toolbar{display:flex;gap:10px;align-items:center;margin:6px 0}
  button{padding:8px 14px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer;font-weight:600}
  button:disabled{opacity:.6;cursor:not-allowed}
  #status{font-size:13px;color:#6b7280}
  svg{width:100%;height:600px;display:block}
  .edge{stroke:var(--edge);stroke-width:2.2;fill:none}
  .node{stroke:#1f2937;stroke-width:1.6}
  .leafText{fill:#111827;font-size:12px;text-anchor:middle;font-weight:600}
  .split{fill:#374151;font-size:12px;text-anchor:middle}
  .tooltip{
    position:absolute; pointer-events:none; z-index:10;
    background:#111827; color:#fff; padding:6px 8px; border-radius:8px;
    font-size:12px; line-height:1.25; box-shadow:0 4px 16px rgba(0,0,0,.15);
    transform:translate(-50%, -120%); white-space:nowrap; opacity:0; transition:opacity .12s ease;
  }
  .tooltip.show{opacity:1;}
</style>
</head>
<body>
<div class="wrap">
  <h1>Random Path Tree Animation</h1>
  <div class="panel">
    <div class="toolbar">
      <button id="run">Run</button>
      <span id="status" aria-live="polite"></span>
    </div>
    <svg id="stage" viewBox="0 0 1000 600" aria-label="Students Decision Tree"></svg>
    <div id="tooltip" class="tooltip" role="tooltip" aria-hidden="true"></div>
  </div>
</div>

<script>
/* ===== Base helpers (same style as your Iris version) ===== */
const NS="http://www.w3.org/2000/svg";
const svg=document.getElementById('stage');
function el(n,a={},p=svg){const e=document.createElementNS(NS,n);for(const[k,v]of Object.entries(a))e.setAttribute(k,v);p.appendChild(e);return e;}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function css(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}

/* ===== Colors ===== */
const COL={
  root:css('--root'), internal:css('--internal'),
  leaf:{ ll:css('--leaf-ll'), lr:css('--leaf-lr'), rl:css('--leaf-rl'), rr:css('--leaf-rr') },
  neutral:css('--ball-neutral')
};

/* ===== Symmetric layout like before ===== */
let N={}, underSlots={}, slotOcc={};
function buildPositions(){
  const y = {r0:100, r1:230, r2:420};
  const x = {root:500, leftI:330, rightI:670, ll:220, lr:440, rl:560, rr:780};

  N = {
    root:   {x:x.root,  y:y.r0, kind:'root'},
    leftI:  {x:x.leftI, y:y.r1, kind:'internal', label:`math score ≤ ${ROOT_THR}`},
    rightI: {x:x.rightI,y:y.r1, kind:'internal', label:`math score > ${ROOT_THR}`},
    ll:     {x:x.ll,    y:y.r2, kind:'leaf', label:'A / A- / A+'},
    lr:     {x:x.lr,    y:y.r2, kind:'leaf', label:'B / B- / B+'},
    rl:     {x:x.rl,    y:y.r2, kind:'leaf', label:'C / C- / C+'},
    rr:     {x:x.rr,    y:y.r2, kind:'leaf', label:'D / F'}
  };

  // 4-line collection grids under leaves
  underSlots = {}; slotOcc = {};
  ['ll','lr','rl','rr'].forEach(k=>{
    underSlots[k] = { cx0: N[k].x - 7*14, y0: N[k].y + 46, dx:14, dy:14 };
  });
}

function drawTree(){
  while(svg.firstChild) svg.removeChild(svg.firstChild);

  // edges
  line(N.root,N.leftI);  line(N.root,N.rightI);
  line(N.leftI,N.ll);    line(N.leftI,N.lr);
  line(N.rightI,N.rl);   line(N.rightI,N.rr);

  // nodes
  circle(N.root, 44, COL.root);
  circle(N.leftI, 38, COL.internal);
  circle(N.rightI,38, COL.internal);
  circle(N.ll,    36, COL.leaf.ll);
  circle(N.lr,    36, COL.leaf.lr);
  circle(N.rl,    36, COL.leaf.rl);
  circle(N.rr,    36, COL.leaf.rr);

  // split labels
  text(N.root.x,  N.root.y-48, `math score threshold = ${ROOT_THR}`, 'split');
  text(N.leftI.x, N.leftI.y-48, `≤ ${ROOT_THR}`, 'split');
  text(N.rightI.x,N.rightI.y-48, `> ${ROOT_THR}`, 'split');

  // leaf labels
  labelLeaf(N.ll, 'll'); labelLeaf(N.lr, 'lr'); labelLeaf(N.rl, 'rl'); labelLeaf(N.rr, 'rr');
}

function line(a,b){el('line',{x1:a.x,y1:a.y,x2:b.x,y2:b.y,class:'edge'});}
function circle(p,r,fill){el('circle',{cx:p.x,cy:p.y,r,fill,class:'node'});}
function text(x,y,content,cls){const t=el('text',{x,y,class:cls}); t.textContent=content; return t;}
function labelLeaf(node,key){ text(node.x, node.y+52, N[key].label, 'leafText'); }

/* ===== Packing: 4 fixed lines under each leaf ===== */
function nextUnderSlot(leafKey){
  if(!slotOcc[leafKey]) slotOcc[leafKey]=0;
  const k = slotOcc[leafKey]++;
  const row = k % 4;                    // 0..3
  const col = Math.floor(k / 4);        // grows to right
  const s = underSlots[leafKey];
  return { cx: s.cx0 + col*s.dx, cy: s.y0 + row*s.dy };
}

/* ===== Data, grading & routing ===== */
function scoreToGPA(s){
  if(s>=98) return 4.3; else if(s>=93) return 4.0; else if(s>=90) return 3.7;
  else if(s>=87) return 3.3; else if(s>=83) return 3.0; else if(s>=80) return 2.7;
  else if(s>=77) return 2.3; else if(s>=73) return 2.0; else if(s>=70) return 1.7;
  else if(s>=65) return 1.0; else return 0.0;
}
function scoreToLetter(s){
  if(s>=98) return 'A+'; else if(s>=93) return 'A'; else if(s>=90) return 'A-';
  else if(s>=87) return 'B+'; else if(s>=83) return 'B'; else if(s>=80) return 'B-';
  else if(s>=77) return 'C+'; else if(s>=73) return 'C'; else if(s>=70) return 'C-';
  else if(s>=65) return 'D'; else return 'F';
}

/* You can replace this with real scores; kept inline so it runs anywhere. */
function makeStudents(n=150){
  const arr=[];
  for(let i=0;i<n;i++){
    // slightly biased distribution: bell-ish around 75 with tails
    const base = Math.min(100, Math.max(0, Math.round( (Math.random()+Math.random())/2 * 40 + 55 )));
    arr.push({ math: base, gpa: scoreToGPA(base), grade: scoreToLetter(base) });
  }
  return arr;
}

/* Tree thresholds (depth 2) – chosen to roughly isolate grade bands */
const ROOT_THR = 85;  // left: ≤85 (mostly C/B), right: >85 (mostly A/B)
const LEFT_THR = 75;  // under left: ≤75 → C band; >75 → B band
const RIGHT_THR = 93; // under right: ≤93 → B+/A-; >93 → A/A+

function routeStudent(s){
  const keys=['root'];
  if(s.math <= ROOT_THR){
    keys.push('leftI');
    if(s.math <= LEFT_THR){ keys.push('rl'); return {keys, leaf:'rl'}; } // C
    else { keys.push('lr'); return {keys, leaf:'lr'}; }                   // B
  }else{
    keys.push('rightI');
    if(s.math <= RIGHT_THR){ keys.push('ll'); return {keys, leaf:'ll'}; } // A-/B+
    else { keys.push('rr'); return {keys, leaf:'rr'}; }                    // A & A+, D/F color kept distinct
  }
}

/* ===== Tooltip ===== */
const tooltip = document.getElementById('tooltip');
function showTip(html, x, y){
  tooltip.innerHTML = html;
  tooltip.style.left = x + 'px';
  tooltip.style.top  = y + 'px';
  tooltip.classList.add('show');
  tooltip.setAttribute('aria-hidden','false');
}
function hideTip(){
  tooltip.classList.remove('show');
  tooltip.setAttribute('aria-hidden','true');
}

/* ===== Animation ===== */
function ball(){ return el('circle',{r:9, fill:COL.neutral, cx:-999, cy:-999}); }
async function moveAlong(keys, d, stepPx=9, frame=14){
  for(let i=0;i<keys.length-1;i++){
    const A=N[keys[i]], B=N[keys[i+1]];
    const dx=B.x-A.x, dy=B.y-A.y, dist=Math.hypot(dx,dy);
    const steps=Math.max(1,Math.floor(dist/stepPx));
    for(let s=0;s<=steps;s++){
      const u=s/steps;
      d.setAttribute('cx', A.x+dx*u);
      d.setAttribute('cy', A.y+dy*u);
      await sleep(frame);
    }
  }
}
async function moveSeg(A,B,d,stepPx=9,frame=12){
  const dx=B.x-A.x, dy=B.y-A.y, dist=Math.hypot(dx,dy);
  const steps=Math.max(1,Math.floor(dist/stepPx));
  for(let s=1;s<=steps;s++){
    const u=s/steps;
    d.setAttribute('cx', A.x+dx*u);
    d.setAttribute('cy', A.y+dy*u);
    await sleep(frame);
  }
}
async function collectUnder(leafKey, sample, d){
  // color adopts the leaf color
  d.setAttribute('fill', COL.leaf[leafKey]);
  const sx=+d.getAttribute('cx'), sy=+d.getAttribute('cy');
  await moveSeg({x:sx,y:sy},{x:sx,y:sy+16}, d, 9, 10);
  const slot=nextUnderSlot(leafKey);
  await moveSeg({x:sx,y:sy+16},{x:slot.cx,y:slot.cy-4}, d, 9, 10);
  await moveSeg({x:slot.cx,y:slot.cy-4},{x:slot.cx,y:slot.cy+6}, d, 8, 9);
  await moveSeg({x:slot.cx,y:slot.cy+6},{x:slot.cx,y:slot.cy}, d, 6, 9);

  // tooltip
  const onMove = (evt)=>{
    showTip(
      `Math: ${sample.math}<br>`+
      `GPA: ${sample.gpa.toFixed(1)}<br>`+
      `Grade: ${sample.grade}<br>`+
      `Leaf: ${leafKey.toUpperCase()}`,
      evt.pageX, evt.pageY
    );
  };
  d.addEventListener('mousemove', onMove);
  d.addEventListener('mouseleave', hideTip);
}

/* ===== Run button ===== */
const btnRun=document.getElementById('run');
btnRun.addEventListener('click', runOnce);
function setStatus(m){ document.getElementById('status').textContent = m?(' '+m):''; }

function rebuildTree(){ buildPositions(); drawTree(); setStatus('Tree ready.'); }

async function runOnce(){
  btnRun.disabled=true;
  const data = makeStudents(160);           // ← change N if you like
  slotOcc={}; setStatus('Running…');

  const order=shuffle([...data.keys()]);
  for(const i of order){
    const s=data[i];
    setStatus(`Running… score=${s.math}`);
    const {keys, leaf}=routeStudent(s);
    const d=ball();
    await moveAlong(keys, d, 9, 12);
    await collectUnder(leaf, s, d);
  }
  setStatus('Done. Hover balls for details.');
  btnRun.disabled=false;
}

/* init */
rebuildTree();
</script>
</body>
</html>
